<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Free Online Image Converter & Optimizer | Convert to JPG, PNG, WebP</title>
    <meta name="description" content="Easily convert and optimize your images online for free. Supports conversion to JPG, PNG, WebP with adjustable quality/compression levels. Fast, secure, and no software needed.">
    <meta name="keywords" content="image converter, image optimizer, convert image, jpg converter, png converter, webp converter, compress image, online tool, free image tool">
    <link rel="canonical" href="https://www.yourwebsite.com/image-converter"> <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-YOUR_ADSENSE_PUBLISHER_ID"
         crossorigin="anonymous"></script> <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Online Image Converter & Optimizer",
      "description": "Free online tool to convert and optimize images to JPG, PNG, and WebP formats with adjustable quality.",
      "applicationCategory": "DesignApplication",
      "operatingSystem": "Any",
      "browserRequirements": "Requires JavaScript and HTML5 Canvas support.",
      "url": "https://www.yourwebsite.com/image-converter" // Replace with your actual URL
    }
    </script>

    <style>
        /* --- Base Styles & Variables --- */
        :root {
            --primary-color: #4A90E2; /* Professional Blue */
            --primary-dark: #3A7BC8;
            --secondary-color: #50E3C2; /* Teal Accent */
            --dark-color: #333;
            --light-color: #f8f9fa;
            --gray-color: #6c757d;
            --light-gray-color: #e9ecef;
            --border-color: #dee2e6;
            --success-color: #28a745;
            --error-color: #dc3545;
            --bg-color: #ffffff;
            --text-color: var(--dark-color);
            --font-family: 'Poppins', sans-serif;
            --border-radius: 6px;
            --box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease-in-out;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--light-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .container {
            width: 90%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }

        h1, h2, h3 {
            color: var(--dark-color);
            margin-bottom: 0.75em;
            line-height: 1.3;
        }

        h1 { font-size: 2.2rem; font-weight: 600; }
        h2 { font-size: 1.6rem; font-weight: 500; }
        h3 { font-size: 1.2rem; font-weight: 500; }

        p { margin-bottom: 1em; }
        a { color: var(--primary-color); text-decoration: none; transition: var(--transition); }
        a:hover { color: var(--primary-dark); text-decoration: underline;}
        img { max-width: 100%; height: auto; display: block; }
        ul { list-style: disc; padding-left: 20px; margin-bottom: 1em;}

        /* --- Header & Footer --- */
        .header {
            background-color: var(--bg-color);
            padding: 1rem 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            border-bottom: 1px solid var(--border-color);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            text-decoration: none;
        }
        .logo:hover { text-decoration: none; color: var(--primary-dark); }

        .footer {
            background-color: var(--dark-color);
            color: var(--light-gray-color);
            padding: 1.5rem 0;
            text-align: center;
            margin-top: auto; /* Push footer to bottom */
            font-size: 0.9rem;
        }
        .footer a { color: var(--secondary-color); }
        .footer a:hover { color: var(--light-color); }


        /* --- Main Content & Tool Section --- */
        .main-content {
            padding: 2rem 0;
            flex-grow: 1; /* Allow main content to fill space */
        }

        .tool-section {
            background-color: var(--bg-color);
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 2rem;
        }
        .tool-section h1 { text-align: center; }
        .subtitle { text-align: center; color: var(--gray-color); margin-bottom: 2rem; font-size: 1.1rem; }

        .converter-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: 2rem;
        }

        .column {
            flex: 1;
            min-width: 280px; /* Ensure columns don't get too squished */
        }

        .column-left { border-right: 1px solid var(--border-color); padding-right: 2rem; }
        /* Remove border on smaller screens */
        @media (max-width: 768px) {
            .column-left { border-right: none; padding-right: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 2rem; margin-bottom: 2rem; }
        }


        /* --- File Input & Preview --- */
        .file-drop-area {
            border: 2px dashed var(--primary-light);
            border-radius: var(--border-radius);
            padding: 2rem;
            text-align: center;
            background-color: #fdfdff;
            transition: background-color 0.2s ease;
            margin-bottom: 1.5rem;
            cursor: pointer;
        }

        .file-drop-area.dragover {
            background-color: #e9f2ff;
            border-color: var(--primary-color);
        }

        .file-drop-area .icon-upload {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .file-drop-area .drop-text {
            font-weight: 500;
            color: var(--dark-color);
        }

        .file-drop-area p {
            color: var(--gray-color);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .image-preview-container {
            margin-top: 1.5rem;
            text-align: center;
        }
        .image-preview-container img {
            max-height: 250px;
            margin: 0 auto 0.5rem auto;
            border: 1px solid var(--border-color);
            padding: 5px;
            border-radius: var(--border-radius);
            background-color: var(--light-gray-color);
        }
        #originalFileInfo {
            font-size: 0.85rem;
            color: var(--gray-color);
        }

        .error-message {
            color: var(--error-color);
            font-weight: 500;
            margin-top: 1rem;
            text-align: center;
        }

        /* --- Options --- */
        .options-group {
            margin-bottom: 1.5rem;
        }

        .options-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .select-css, input[type="range"] {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            background-color: #fff;
        }
        .select-css {
            appearance: none; /* Custom arrow */
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007bff%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right .7em top 50%;
            background-size: .65em auto;
            padding-right: 2.5em; /* Space for arrow */
        }


        /* --- Slider Customization --- */
        .slider-css {
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            background: var(--light-gray-color);
            outline: none;
            opacity: 0.9;
            transition: opacity .2s;
            border-radius: 5px;
            cursor: pointer;
            padding: 0; /* Override padding */
        }
        .slider-css:hover { opacity: 1; }

        .slider-css::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
        }

        .slider-css::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
            border: none; /* Necessary for Firefox */
        }
        .options-group small {
            display: block;
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: var(--gray-color);
        }

        /* --- Buttons --- */
        .btn {
            display: inline-block;
            padding: 0.8rem 1.5rem;
            font-size: 1rem;
            font-weight: 500;
            text-align: center;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            margin-right: 0.5rem; /* Spacing between buttons if needed */
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: #fff;
        }
        .btn-primary:hover:not(:disabled) { background-color: var(--primary-dark); }

        .btn-convert {
            background-color: var(--secondary-color);
            color: var(--dark-color);
            width: 100%; /* Make convert button full width */
            margin-top: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5em;
        }
        .btn-convert:hover:not(:disabled) { background-color: #45ccb0; }

        .btn-success {
            background-color: var(--success-color);
            color: #fff;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5em;
        }
        .btn-success:hover:not(:disabled) { background-color: #218838; }


        /* --- Output Section --- */
        .output-section {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }
        #outputFileInfo {
            font-size: 0.9rem;
            color: var(--gray-color);
            margin-bottom: 1rem;
            text-align: center;
        }

        /* --- Loading Spinner --- */
        .icon-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }


        /* --- Ad Spaces --- */
        .ad-space {
            background-color: var(--light-gray-color);
            border: 1px dashed var(--gray-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 2rem auto; /* Center ad blocks */
            overflow: hidden; /* Prevent ad content overflow */
            /* Ensure AdSense container itself doesn't collapse */
            min-width: 100px;
             min-height: 50px;
        }
        .ad-banner-top {
            min-height: 90px; /* Placeholder height */
            width: 100%;
            max-width: 728px; /* Common banner size */
        }
        .ad-inline {
            min-height: 250px; /* Placeholder height */
            width: 100%;
            max-width: 300px; /* Common inline size */
            margin-top: 1.5rem; /* Space above inline ad */
        }
        .ad-placeholder-text {
            color: var(--gray-color);
            font-size: 0.9rem;
            margin: 0; /* Remove default paragraph margin */
            padding: 10px; /* Add some padding inside the placeholder */
        }
        /* Hide placeholder text when AdSense fills the space */
        .adsbygoogle[data-ad-status="filled"] {
             background-color: transparent !important; /* Ensure ad background shows */
             border: none !important; /* Remove placeholder border */
        }
        .adsbygoogle[data-ad-status="filled"] + .ad-placeholder-text,
        .adsbygoogle[data-ad-status="filled"] ~ .ad-placeholder-text {
            display: none;
        }
        .adsbygoogle:not([data-ad-status="filled"]) {
            /* Style the ad container itself before ad loads */
            background-color: #f0f0f0;
        }
        /* AdSense specific style */
        ins.adsbygoogle {
             display: block; /* Make sure ins tag takes up space */
             text-align: center; /* Center the ad content if smaller than container */
             background: transparent; /* Default AdSense style */
        }


        /* --- Info Content --- */
        .info-content {
            background-color: var(--bg-color);
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-top: 2rem;
        }


        /* --- Responsive Adjustments --- */
        @media (max-width: 992px) {
            h1 { font-size: 2rem; }
            h2 { font-size: 1.4rem; }
            .container { width: 95%; }
        }

        @media (max-width: 768px) {
            .converter-wrapper { flex-direction: column; gap: 0; } /* Stack columns */
            .column { min-width: 100%; } /* Full width */
            .tool-section { padding: 1.5rem; }
            h1 { font-size: 1.8rem; }
        }

        @media (max-width: 576px) {
            h1 { font-size: 1.6rem; }
            .subtitle { font-size: 1rem; }
            .btn { padding: 0.6rem 1rem; font-size: 0.9rem; }
            .tool-section { padding: 1rem; }
            .file-drop-area { padding: 1.5rem; }
            .file-drop-area .icon-upload { font-size: 2.5rem; }
            .ad-inline { max-width: 100%; min-height: 100px; } /* Adjust inline ad for small screens */
        }
    </style>

</head>
<body>

    <header class="header">
        <div class="container">
            <a href="/" class="logo">ImageTool Pro</a>
            </div>
    </header>

    <main class="main-content">
        <div class="container">

            <section class="ad-space ad-banner-top">
                <ins class="adsbygoogle"
                     style="display:block"
                     data-ad-client="ca-pub-YOUR_ADSENSE_PUBLISHER_ID" data-ad-slot="YOUR_AD_SLOT_ID_1" data-ad-format="auto"
                     data-full-width-responsive="true"></ins>
                 <p class="ad-placeholder-text">Top Banner Ad</p> <script>
                     try { (adsbygoogle = window.adsbygoogle || []).push({}); } catch (e) { console.error("AdSense error:", e); }
                </script>
            </section>

            <section class="tool-section">
                <h1>Online Image Converter & Optimizer</h1>
                <p class="subtitle">Convert your images to JPG, PNG, or WebP format and adjust the quality/compression level.</p>

                <div class="converter-wrapper">
                    <div class="column column-left">
                        <h2>1. Upload Your Image</h2>
                        <div class="file-drop-area" id="fileDropArea">
                            <i class="fas fa-cloud-upload-alt icon-upload"></i>
                            <p class="drop-text">Drag & drop your image here</p>
                            <p>or</p>
                            <label for="fileInput" class="btn btn-primary">Browse Files</label>
                            <input type="file" id="fileInput" accept="image/jpeg, image/png, image/gif, image/bmp, image/webp" hidden>
                        </div>
                        <div id="imagePreviewContainer" class="image-preview-container" style="display: none;">
                             <h3>Original Preview:</h3>
                            <img id="imagePreview" src="#" alt="Image Preview">
                            <p id="originalFileInfo"></p>
                        </div>
                        <div id="errorMessage" class="error-message"></div>
                    </div>

                    <div class="column column-right">
                        <h2>2. Set Conversion Options</h2>
                        <div class="options-group">
                            <label for="outputFormat">Convert to:</label>
                            <select id="outputFormat" class="select-css">
                                <option value="image/jpeg">JPG</option>
                                <option value="image/png">PNG</option>
                                <option value="image/webp">WebP</option>
                            </select>
                        </div>

                        <div class="options-group" id="qualityGroup">
                            <label for="qualitySlider">Quality (Compression): <span id="qualityValue">90</span>%</label>
                            <input type="range" id="qualitySlider" min="0" max="100" value="90" class="slider-css">
                            <small>(Lower quality = smaller file size. Not applicable for PNG)</small>
                        </div>

                        <button id="convertBtn" class="btn btn-convert" disabled>
                            <i class="fas fa-sync-alt icon-spin" style="display: none;"></i>
                            Convert Image
                        </button>

                        <div id="outputSection" class="output-section" style="display: none;">
                            <h2>3. Download Result</h2>
                            <p id="outputFileInfo"></p>
                            <a id="downloadLink" href="#" download="converted_image.jpg" class="btn btn-success">
                                <i class="fas fa-download"></i> Download Converted Image
                            </a>
                        </div>
                         <section class="ad-space ad-inline">
                            <ins class="adsbygoogle"
                                 style="display:block"
                                 data-ad-client="ca-pub-YOUR_ADSENSE_PUBLISHER_ID" data-ad-slot="YOUR_AD_SLOT_ID_2" data-ad-format="auto"
                                 data-full-width-responsive="true"></ins>
                             <p class="ad-placeholder-text">Inline Ad</p> <script>
                                 try { (adsbygoogle = window.adsbygoogle || []).push({}); } catch (e) { console.error("AdSense error:", e); }
                            </script>
                        </section>
                     </div>
                 </div>
             </section>

             <section class="info-content">
                 <h2>How Our Image Converter Works</h2>
                 <p>This tool allows you to convert images directly in your browser. Simply upload your image, choose the desired output format (JPG, PNG, or WebP), adjust the quality settings for lossy formats like JPG and WebP, and click 'Convert'. Your browser handles the conversion process locally, ensuring your files remain private.</p>

                 <h2>Benefits of Optimizing Images</h2>
                 <ul>
                     <li><strong>Faster Website Loading:</strong> Smaller images load quicker, improving user experience and SEO.</li>
                     <li><strong>Reduced Bandwidth Usage:</strong> Saves bandwidth for both you and your visitors.</li>
                     <li><strong>Better SEO Rankings:</strong> Page speed is a ranking factor for search engines like Google.</li>
                     <li><strong>Improved User Experience:</strong> No one likes waiting for large images to load.</li>
                 </ul>

                 <h2>Supported Input Formats</h2>
                 <p>While we can convert *to* JPG, PNG, and WebP, you can typically upload common formats like JPG, PNG, GIF, BMP, and sometimes WebP (browser support varies).</p>

                 </section>

         </div>
     </main>

     <footer class="footer">
         <div class="container">
             <p>&copy; <span id="currentYear"></span> Your Website Name. All rights reserved.</p>
             </div>
     </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const fileInput = document.getElementById('fileInput');
            const fileDropArea = document.getElementById('fileDropArea');
            const imagePreviewContainer = document.getElementById('imagePreviewContainer');
            const imagePreview = document.getElementById('imagePreview');
            const originalFileInfo = document.getElementById('originalFileInfo');
            const errorMessage = document.getElementById('errorMessage');

            const outputFormatSelect = document.getElementById('outputFormat');
            const qualityGroup = document.getElementById('qualityGroup');
            const qualitySlider = document.getElementById('qualitySlider');
            const qualityValueSpan = document.getElementById('qualityValue');

            const convertBtn = document.getElementById('convertBtn');
            const convertBtnIcon = convertBtn.querySelector('.icon-spin');
            const outputSection = document.getElementById('outputSection');
            const outputFileInfo = document.getElementById('outputFileInfo');
            const downloadLink = document.getElementById('downloadLink');

            const currentYearSpan = document.getElementById('currentYear');

            // --- State ---
            let currentFile = null;
            let originalFileName = '';
            let originalFileType = '';
            let originalFileSize = 0;

            // --- Functions ---

            // Update UI based on selected format
            function updateQualityControl() {
                const selectedFormat = outputFormatSelect.value;
                if (selectedFormat === 'image/png') {
                    qualityGroup.style.display = 'none'; // PNG is lossless, quality doesn't apply
                } else {
                    qualityGroup.style.display = 'block';
                }
                // Update download link type hint only if a file is loaded
                 if (originalFileName) {
                    updateDownloadLinkAttributes();
                 }
            }

             // Update download link attributes (name and type)
             function updateDownloadLinkAttributes() {
                 const selectedFormat = outputFormatSelect.value;
                 const quality = qualitySlider.value;
                 const baseName = originalFileName.split('.').slice(0, -1).join('.') || 'converted';
                 let extension = selectedFormat.split('/')[1]; // jpeg, png, webp

                 // Correct extension for jpeg
                 if (extension === 'jpeg') extension = 'jpg';

                 // Construct filename based on format
                 let downloadFilename = `${baseName}.${extension}`;
                 if (selectedFormat !== 'image/png') {
                     downloadFilename = `${baseName}_q${quality}.${extension}`;
                 }

                 downloadLink.download = downloadFilename;
             }


            // Display image preview and info
            function displayPreview(file) {
                // Basic validation
                 if (!file.type.startsWith('image/')) {
                     showError('Invalid file type. Please upload an image.');
                     resetTool();
                     return;
                 }
                 // Optional: Add file size limit (e.g., 10MB)
                 const maxSize = 10 * 1024 * 1024; // 10 MB
                 if (file.size > maxSize) {
                     showError(`File is too large (${formatFileSize(file.size)}). Maximum size is ${formatFileSize(maxSize)}.`);
                     resetTool();
                     return;
                 }


                errorMessage.textContent = ''; // Clear previous errors
                const reader = new FileReader();

                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreviewContainer.style.display = 'block';
                    originalFileName = file.name;
                    originalFileType = file.type;
                    originalFileSize = file.size;
                    originalFileInfo.textContent = `Original: ${originalFileName} (${formatFileSize(originalFileSize)})`;
                    convertBtn.disabled = false; // Enable convert button
                    outputSection.style.display = 'none'; // Hide previous output
                    updateQualityControl(); // Update controls based on default format
                    updateDownloadLinkAttributes(); // Set initial download name
                };

                reader.onerror = () => {
                    showError('Error reading file.');
                    resetTool();
                };

                reader.readAsDataURL(file);
                currentFile = file; // Store the file object
            }

            // Format file size
            function formatFileSize(bytes, decimals = 2) {
                if (bytes === 0) return '0 Bytes';
                if (bytes < 0) return 'Invalid Size'; // Handle potential negative values if needed
                const k = 1024;
                const dm = decimals < 0 ? 0 : decimals;
                const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                 // Handle potential log(0) or log(negative) issues
                 if (bytes < 1) return `${bytes} Bytes`;
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                 // Ensure index doesn't go out of bounds for very large numbers
                 const index = Math.min(i, sizes.length - 1);
                return parseFloat((bytes / Math.pow(k, index)).toFixed(dm)) + ' ' + sizes[index];
            }

             // Show error message
            function showError(message) {
                errorMessage.textContent = message;
                imagePreviewContainer.style.display = 'none';
                convertBtn.disabled = true;
            }

            // Reset tool state
            function resetTool() {
                currentFile = null;
                originalFileName = '';
                originalFileType = '';
                originalFileSize = 0;
                fileInput.value = ''; // Clear file input
                imagePreviewContainer.style.display = 'none';
                imagePreview.src = '#';
                originalFileInfo.textContent = '';
                convertBtn.disabled = true;
                outputSection.style.display = 'none';
                errorMessage.textContent = '';
                outputFormatSelect.value = 'image/jpeg'; // Reset format
                qualitySlider.value = 90; // Reset quality
                qualityValueSpan.textContent = '90';
                updateQualityControl();
            }

            // Handle image conversion
            function convertImage() {
                if (!currentFile) {
                    showError('Please upload an image first.');
                    return;
                }

                convertBtn.disabled = true;
                convertBtnIcon.style.display = 'inline-block'; // Show spinner
                errorMessage.textContent = ''; // Clear errors
                outputSection.style.display = 'none';

                // Use existing preview src if possible to avoid re-reading,
                // but re-reading ensures we have the latest file data if needed.
                // Let's stick to using the preview src for simplicity here.
                const img = new Image();

                img.onload = () => {
                    // Check for potentially huge images that might crash canvas
                    const MAX_CANVAS_AREA = 32 * 1024 * 1024; // Example limit: 32 Megapixels
                    if (img.naturalWidth * img.naturalHeight > MAX_CANVAS_AREA) {
                        showError(`Image dimensions are too large (${img.naturalWidth}x${img.naturalHeight}) for reliable browser conversion.`);
                        convertBtn.disabled = false;
                        convertBtnIcon.style.display = 'none';
                        return;
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = img.naturalWidth;
                    canvas.height = img.naturalHeight;
                    const ctx = canvas.getContext('2d');

                    // Optional: Fill background for formats that support transparency (like converting PNG to JPG)
                    // if (outputFormatSelect.value === 'image/jpeg') {
                    //     ctx.fillStyle = '#FFFFFF'; // White background
                    //     ctx.fillRect(0, 0, canvas.width, canvas.height);
                    // }

                    ctx.drawImage(img, 0, 0);

                    const outputFormat = outputFormatSelect.value;
                    let quality = 1.0; // Default for PNG or if slider hidden

                    if (outputFormat !== 'image/png') {
                        quality = parseInt(qualitySlider.value, 10) / 100;
                    }

                    try {
                        // Use a Promise to handle potential async nature or errors in toDataURL
                        new Promise((resolve, reject) => {
                            try {
                                const dataUrl = canvas.toDataURL(outputFormat, quality);
                                if (!dataUrl || dataUrl === "data:,") { // Check for empty or invalid data URL
                                    reject(new Error("Canvas generated empty or invalid data URL."));
                                } else {
                                    resolve(dataUrl);
                                }
                            } catch (error) {
                                reject(error); // Catch synchronous errors during conversion
                            }
                        })
                        .then(dataUrl => {
                            // Estimate new file size (approximate)
                            const head = 'data:' + outputFormat + ';base64,';
                            const approxBytes = Math.round((dataUrl.length - head.length) * 3 / 4);

                            outputFileInfo.textContent = `Converted Size: ~${formatFileSize(approxBytes)}`;
                            downloadLink.href = dataUrl;
                            updateDownloadLinkAttributes(); // Ensure name is correct

                            outputSection.style.display = 'block';
                        })
                        .catch(error => {
                            console.error("Canvas conversion error:", error);
                            let userMessage = "Conversion failed. ";
                            if (error.message.includes("SecurityError")) {
                                userMessage += "Could not process image due to security restrictions (e.g., tainted canvas). Try uploading the file directly.";
                            } else if (error.message.includes("type is not supported")) {
                                userMessage += `The selected output format (${outputFormat}) might not be supported by your browser.`;
                            } else if (error.message.includes("invalid data URL")) {
                                userMessage += "The browser could not generate valid image data, possibly due to image complexity or size.";
                            }
                             else {
                                userMessage += "An unexpected error occurred during conversion.";
                            }
                            showError(userMessage);
                        })
                        .finally(() => {
                            convertBtn.disabled = false;
                            convertBtnIcon.style.display = 'none'; // Hide spinner
                        });

                    } catch (error) {
                         // Catch potential synchronous errors outside the Promise setup (less likely)
                         console.error("Outer conversion error:", error);
                         showError(`Conversion failed. An unexpected error occurred. ${error.message}`);
                         convertBtn.disabled = false;
                         convertBtnIcon.style.display = 'none'; // Hide spinner
                    }
                };

                img.onerror = () => {
                    showError('Could not load image data for conversion. The file might be corrupted or in an unsupported format.');
                    convertBtn.disabled = false;
                    convertBtnIcon.style.display = 'none';
                };

                // Set src AFTER onload/onerror are defined
                img.src = imagePreview.src; // Use the already loaded preview source
            }


            // --- Event Listeners ---

            // File Input Change
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    displayPreview(file);
                } else {
                    resetTool(); // Reset if selection is cancelled
                }
            });

            // Drag and Drop
            fileDropArea.addEventListener('dragover', (e) => {
                e.preventDefault(); // Necessary to allow drop
                fileDropArea.classList.add('dragover');
            });
            fileDropArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                fileDropArea.classList.remove('dragover');
            });
            fileDropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                fileDropArea.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file) {
                    // Manually set the file input's files property for consistency
                    try {
                         const dataTransfer = new DataTransfer();
                         dataTransfer.items.add(file);
                         fileInput.files = dataTransfer.files;
                         // Trigger change event manually
                         fileInput.dispatchEvent(new Event('change', { bubbles: true })); // Ensure event bubbles if needed
                    } catch (err) {
                         console.error("Error setting dropped file:", err);
                         // Fallback if DataTransfer method fails in some envs
                         displayPreview(file);
                    }
                }
            });
            // Trigger file input click when drop area is clicked (excluding the button/label)
            fileDropArea.addEventListener('click', (e) => {
                 // Check if the click target is the area itself or one of its direct children (like P or I tags)
                 // but not the label or the hidden input
                if (e.target === fileDropArea || e.target.classList.contains('icon-upload') || e.target.classList.contains('drop-text') || e.target.tagName === 'P' ) {
                     fileInput.click();
                }
            });


            // Quality Slider Input
            qualitySlider.addEventListener('input', (e) => {
                qualityValueSpan.textContent = e.target.value;
                 // Update download filename hint dynamically as quality changes
                 if (currentFile) {
                     updateDownloadLinkAttributes();
                 }
            });

            // Output Format Change
            outputFormatSelect.addEventListener('change', updateQualityControl);

            // Convert Button Click
            convertBtn.addEventListener('click', convertImage);

            // Set current year in footer
            if (currentYearSpan) {
                currentYearSpan.textContent = new Date().getFullYear();
            }

            // --- Initial Setup ---
            updateQualityControl(); // Set initial state for quality control

        });
    </script>

</body>
</html>
